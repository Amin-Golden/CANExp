{"ast":null,"code":"'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _regenerator = require('babel-runtime/regenerator');\n\nvar _regenerator2 = _interopRequireDefault(_regenerator);\n\nvar _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');\n\nvar _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);\n\nvar _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require('babel-runtime/helpers/createClass');\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _canMessage = require('can-message');\n\nvar _weakmapEvent = require('weakmap-event');\n\nvar _weakmapEvent2 = _interopRequireDefault(_weakmapEvent);\n\nvar _ap = require('ap');\n\nvar _performanceNow = require('performance-now');\n\nvar _performanceNow2 = _interopRequireDefault(_performanceNow);\n\nvar _delay = require('../delay');\n\nvar _delay2 = _interopRequireDefault(_delay);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nvar PANDA_VENDOR_ID = 0xbbaa; //const PANDA_PRODUCT_ID = 0xddcc;\n\nvar BUFFER_SIZE = 0x10 * 256;\nvar ErrorEvent = (0, _weakmapEvent2.default)();\nvar ConnectEvent = (0, _weakmapEvent2.default)();\nvar DisconnectEvent = (0, _weakmapEvent2.default)();\n\nvar Panda = function () {\n  function Panda(options, usb) {\n    (0, _classCallCheck3.default)(this, Panda);\n    this.usb = usb;\n    this.device = null;\n    this.onError = (0, _ap.partial)(ErrorEvent.listen, this);\n    this.onConnect = (0, _ap.partial)(ConnectEvent.listen, this);\n    this.onDisconnect = (0, _ap.partial)(DisconnectEvent.listen, this);\n  }\n\n  (0, _createClass3.default)(Panda, [{\n    key: 'connect',\n    value: function () {\n      var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee() {\n        return _regenerator2.default.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.next = 2;\n                return this.usb.requestDevice({\n                  filters: [{\n                    vendorId: PANDA_VENDOR_ID\n                  }]\n                });\n\n              case 2:\n                this.device = _context.sent;\n                _context.next = 5;\n                return this.device.open();\n\n              case 5:\n                _context.next = 7;\n                return this.device.selectConfiguration(1);\n\n              case 7:\n                _context.next = 9;\n                return this.device.claimInterface(0);\n\n              case 9:\n                return _context.abrupt('return', true);\n\n              case 10:\n              case 'end':\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function connect() {\n        return _ref.apply(this, arguments);\n      }\n\n      return connect;\n    }()\n  }, {\n    key: 'disconnect',\n    value: function () {\n      var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2() {\n        return _regenerator2.default.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                if (this.device) {\n                  _context2.next = 2;\n                  break;\n                }\n\n                return _context2.abrupt('return', false);\n\n              case 2:\n                _context2.next = 4;\n                return this.device.close();\n\n              case 4:\n                this.device = null;\n                return _context2.abrupt('return', true);\n\n              case 6:\n              case 'end':\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function disconnect() {\n        return _ref2.apply(this, arguments);\n      }\n\n      return disconnect;\n    }()\n  }, {\n    key: 'vendorRequest',\n    value: function () {\n      var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee3(data, length) {\n        var controlParams, result;\n        return _regenerator2.default.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                // data is request, value, index\n                controlParams = {\n                  requestType: 'vendor',\n                  recipient: 'device',\n                  request: data.request,\n                  value: data.value,\n                  index: data.index\n                };\n                _context3.next = 3;\n                return this.device.controlTransferIn(controlParams, length);\n\n              case 3:\n                result = _context3.sent;\n                result = {\n                  data: Buffer.from(result.data.buffer),\n                  status: result.status\n                };\n                return _context3.abrupt('return', result);\n\n              case 6:\n              case 'end':\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function vendorRequest(_x, _x2) {\n        return _ref3.apply(this, arguments);\n      }\n\n      return vendorRequest;\n    }()\n  }, {\n    key: 'vendorWrite',\n    value: function () {\n      var _ref4 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee4(data, length) {\n        var controlParams;\n        return _regenerator2.default.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                // data is request, value, index\n                controlParams = {\n                  requestType: 'vendor',\n                  recipient: 'device',\n                  request: data.request,\n                  value: data.value,\n                  index: data.index\n                };\n                _context4.next = 3;\n                return this.device.controlTransferOut(controlParams, length);\n\n              case 3:\n                return _context4.abrupt('return', true);\n\n              case 4:\n              case 'end':\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n\n      function vendorWrite(_x3, _x4) {\n        return _ref4.apply(this, arguments);\n      }\n\n      return vendorWrite;\n    }() // not used anymore, but is nice for reference\n\n  }, {\n    key: 'nextFakeMessage',\n    value: function () {\n      var _ref5 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee5() {\n        return _regenerator2.default.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                _context5.next = 2;\n                return (0, _delay2.default)(10);\n\n              case 2:\n                return _context5.abrupt('return', (0, _canMessage.packCAN)({\n                  address: 0,\n                  busTime: ~~(Math.random() * 65000),\n                  data: ''.padEnd(16, '0'),\n                  bus: 0\n                }));\n\n              case 3:\n              case 'end':\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this);\n      }));\n\n      function nextFakeMessage() {\n        return _ref5.apply(this, arguments);\n      }\n\n      return nextFakeMessage;\n    }()\n  }, {\n    key: 'nextMessage',\n    value: function () {\n      var _ref6 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee6() {\n        var result, attempts;\n        return _regenerator2.default.wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                result = null;\n                attempts = 0;\n\n              case 2:\n                if (!(result === null)) {\n                  _context6.next = 17;\n                  break;\n                }\n\n                _context6.prev = 3;\n                _context6.next = 6;\n                return this.device.transferIn(1, BUFFER_SIZE);\n\n              case 6:\n                result = _context6.sent;\n                _context6.next = 15;\n                break;\n\n              case 9:\n                _context6.prev = 9;\n                _context6.t0 = _context6['catch'](3);\n                console.warn('can_recv failed, retrying');\n                attempts = Math.min(++attempts, 10);\n                _context6.next = 15;\n                return (0, _delay2.default)(attempts * 100);\n\n              case 15:\n                _context6.next = 2;\n                break;\n\n              case 17:\n                return _context6.abrupt('return', result.data.buffer);\n\n              case 18:\n              case 'end':\n                return _context6.stop();\n            }\n          }\n        }, _callee6, this, [[3, 9]]);\n      }));\n\n      function nextMessage() {\n        return _ref6.apply(this, arguments);\n      }\n\n      return nextMessage;\n    }()\n  }]);\n  return Panda;\n}();\n\nexports.default = Panda;","map":{"version":3,"sources":["/home/amax/Autoro/cabana/node_modules/@commaai/pandajs/lib/impl/browser.js"],"names":["Object","defineProperty","exports","value","_regenerator","require","_regenerator2","_interopRequireDefault","_asyncToGenerator2","_asyncToGenerator3","_classCallCheck2","_classCallCheck3","_createClass2","_createClass3","_canMessage","_weakmapEvent","_weakmapEvent2","_ap","_performanceNow","_performanceNow2","_delay","_delay2","obj","__esModule","default","PANDA_VENDOR_ID","BUFFER_SIZE","ErrorEvent","ConnectEvent","DisconnectEvent","Panda","options","usb","device","onError","partial","listen","onConnect","onDisconnect","key","_ref","mark","_callee","wrap","_callee$","_context","prev","next","requestDevice","filters","vendorId","sent","open","selectConfiguration","claimInterface","abrupt","stop","connect","apply","arguments","_ref2","_callee2","_callee2$","_context2","close","disconnect","_ref3","_callee3","data","length","controlParams","result","_callee3$","_context3","requestType","recipient","request","index","controlTransferIn","Buffer","from","buffer","status","vendorRequest","_x","_x2","_ref4","_callee4","_callee4$","_context4","controlTransferOut","vendorWrite","_x3","_x4","_ref5","_callee5","_callee5$","_context5","packCAN","address","busTime","Math","random","padEnd","bus","nextFakeMessage","_ref6","_callee6","attempts","_callee6$","_context6","transferIn","t0","console","warn","min","nextMessage"],"mappings":"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","sourcesContent":["'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _regenerator = require('babel-runtime/regenerator');\n\nvar _regenerator2 = _interopRequireDefault(_regenerator);\n\nvar _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');\n\nvar _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);\n\nvar _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require('babel-runtime/helpers/createClass');\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _canMessage = require('can-message');\n\nvar _weakmapEvent = require('weakmap-event');\n\nvar _weakmapEvent2 = _interopRequireDefault(_weakmapEvent);\n\nvar _ap = require('ap');\n\nvar _performanceNow = require('performance-now');\n\nvar _performanceNow2 = _interopRequireDefault(_performanceNow);\n\nvar _delay = require('../delay');\n\nvar _delay2 = _interopRequireDefault(_delay);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nvar PANDA_VENDOR_ID = 0xbbaa;\n//const PANDA_PRODUCT_ID = 0xddcc;\n\nvar BUFFER_SIZE = 0x10 * 256;\n\nvar ErrorEvent = (0, _weakmapEvent2.default)();\nvar ConnectEvent = (0, _weakmapEvent2.default)();\nvar DisconnectEvent = (0, _weakmapEvent2.default)();\n\nvar Panda = function () {\n  function Panda(options, usb) {\n    (0, _classCallCheck3.default)(this, Panda);\n\n    this.usb = usb;\n    this.device = null;\n    this.onError = (0, _ap.partial)(ErrorEvent.listen, this);\n    this.onConnect = (0, _ap.partial)(ConnectEvent.listen, this);\n    this.onDisconnect = (0, _ap.partial)(DisconnectEvent.listen, this);\n  }\n\n  (0, _createClass3.default)(Panda, [{\n    key: 'connect',\n    value: function () {\n      var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee() {\n        return _regenerator2.default.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.next = 2;\n                return this.usb.requestDevice({\n                  filters: [{ vendorId: PANDA_VENDOR_ID }]\n                });\n\n              case 2:\n                this.device = _context.sent;\n                _context.next = 5;\n                return this.device.open();\n\n              case 5:\n                _context.next = 7;\n                return this.device.selectConfiguration(1);\n\n              case 7:\n                _context.next = 9;\n                return this.device.claimInterface(0);\n\n              case 9:\n                return _context.abrupt('return', true);\n\n              case 10:\n              case 'end':\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function connect() {\n        return _ref.apply(this, arguments);\n      }\n\n      return connect;\n    }()\n  }, {\n    key: 'disconnect',\n    value: function () {\n      var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2() {\n        return _regenerator2.default.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                if (this.device) {\n                  _context2.next = 2;\n                  break;\n                }\n\n                return _context2.abrupt('return', false);\n\n              case 2:\n                _context2.next = 4;\n                return this.device.close();\n\n              case 4:\n                this.device = null;\n\n                return _context2.abrupt('return', true);\n\n              case 6:\n              case 'end':\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function disconnect() {\n        return _ref2.apply(this, arguments);\n      }\n\n      return disconnect;\n    }()\n  }, {\n    key: 'vendorRequest',\n    value: function () {\n      var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee3(data, length) {\n        var controlParams, result;\n        return _regenerator2.default.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                // data is request, value, index\n                controlParams = {\n                  requestType: 'vendor',\n                  recipient: 'device',\n                  request: data.request,\n                  value: data.value,\n                  index: data.index\n                };\n                _context3.next = 3;\n                return this.device.controlTransferIn(controlParams, length);\n\n              case 3:\n                result = _context3.sent;\n\n                result = {\n                  data: Buffer.from(result.data.buffer),\n                  status: result.status\n                };\n                return _context3.abrupt('return', result);\n\n              case 6:\n              case 'end':\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function vendorRequest(_x, _x2) {\n        return _ref3.apply(this, arguments);\n      }\n\n      return vendorRequest;\n    }()\n  }, {\n    key: 'vendorWrite',\n    value: function () {\n      var _ref4 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee4(data, length) {\n        var controlParams;\n        return _regenerator2.default.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                // data is request, value, index\n                controlParams = {\n                  requestType: 'vendor',\n                  recipient: 'device',\n                  request: data.request,\n                  value: data.value,\n                  index: data.index\n                };\n                _context4.next = 3;\n                return this.device.controlTransferOut(controlParams, length);\n\n              case 3:\n                return _context4.abrupt('return', true);\n\n              case 4:\n              case 'end':\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n\n      function vendorWrite(_x3, _x4) {\n        return _ref4.apply(this, arguments);\n      }\n\n      return vendorWrite;\n    }()\n\n    // not used anymore, but is nice for reference\n\n  }, {\n    key: 'nextFakeMessage',\n    value: function () {\n      var _ref5 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee5() {\n        return _regenerator2.default.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                _context5.next = 2;\n                return (0, _delay2.default)(10);\n\n              case 2:\n                return _context5.abrupt('return', (0, _canMessage.packCAN)({\n                  address: 0,\n                  busTime: ~~(Math.random() * 65000),\n                  data: ''.padEnd(16, '0'),\n                  bus: 0\n                }));\n\n              case 3:\n              case 'end':\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this);\n      }));\n\n      function nextFakeMessage() {\n        return _ref5.apply(this, arguments);\n      }\n\n      return nextFakeMessage;\n    }()\n  }, {\n    key: 'nextMessage',\n    value: function () {\n      var _ref6 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee6() {\n        var result, attempts;\n        return _regenerator2.default.wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                result = null;\n                attempts = 0;\n\n              case 2:\n                if (!(result === null)) {\n                  _context6.next = 17;\n                  break;\n                }\n\n                _context6.prev = 3;\n                _context6.next = 6;\n                return this.device.transferIn(1, BUFFER_SIZE);\n\n              case 6:\n                result = _context6.sent;\n                _context6.next = 15;\n                break;\n\n              case 9:\n                _context6.prev = 9;\n                _context6.t0 = _context6['catch'](3);\n\n                console.warn('can_recv failed, retrying');\n                attempts = Math.min(++attempts, 10);\n                _context6.next = 15;\n                return (0, _delay2.default)(attempts * 100);\n\n              case 15:\n                _context6.next = 2;\n                break;\n\n              case 17:\n                return _context6.abrupt('return', result.data.buffer);\n\n              case 18:\n              case 'end':\n                return _context6.stop();\n            }\n          }\n        }, _callee6, this, [[3, 9]]);\n      }));\n\n      function nextMessage() {\n        return _ref6.apply(this, arguments);\n      }\n\n      return nextMessage;\n    }()\n  }]);\n  return Panda;\n}();\n\nexports.default = Panda;"]},"metadata":{},"sourceType":"script"}